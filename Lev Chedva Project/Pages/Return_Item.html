<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles/Return_Item.css">
    <title>החזר מוצר</title>
</head>
<body>
    <input type="text" id="search-input" placeholder="Enter item ID or categorial number..." />
    <button id="search-by-id-btn">חפש לפי ת.ז</button>
    <button id="search-by-cat-btn">חפש לפי מק"ט</button>
    <div id="buttonContainer"></div>
    <div id="item-data" style="display: none;"></div>
    <div id="return-details" style="display: none;">
        <div id="accessories-list" style="display: none;"></div>
        <label>כמות: <input type="number" id="return-quantity" /></label>
        <label>"שם המתנדב" <input type="text" id="return-name" /></label>
        <label>מיקום:
            <select id="return-location">
            </select>
        </label>
        <button id="return-btn">החזר</button>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="../firebase.js"></script>
    <script>
        const searchInput = document.getElementById('search-input');
        const searchByIdBtn = document.getElementById('search-by-id-btn');
        const searchByCatBtn = document.getElementById('search-by-cat-btn');
        const itemData = document.getElementById('item-data');
        const returnDetails = document.getElementById('return-details');
        const returnBtn = document.getElementById('return-btn');
        const returnName = document.getElementById('return-name');
        const returnLocation = document.getElementById('return-location');
        const accessoriesListDiv = document.getElementById('accessories-list');
        let foundItemId = null;
        let foundItemCategorialNumber = null;
        let ChosenTicket;
    async function getLocations() {
            const locationsRef = firebase.firestore().collection('Tools').doc('Locations');
            const locationsSnapshot = await locationsRef.get();
            const locations = locationsSnapshot.data().Location;

            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.text = location;
                returnLocation.add(option);
            });
        }

        getLocations();

        async function searchItemById(itemId) {
    const borrowedItemsRef = firebase.firestore().collection('Borrowed Items');
    const docSnapshot = await borrowedItemsRef.doc(itemId).get();

    if (!docSnapshot.exists) {
        alert('המוצר לא נמצא.');
        return;
    }

    const item = docSnapshot.data();
    const tickets = item.borrowTickets.map(String);   

    // Get a reference to the container where you want to append the ticket buttons
    const buttonContainer = document.getElementById('buttonContainer');
    buttonContainer.style.display = 'flex';
    buttonContainer.style.flexDirection = 'column-reverse';

    // Create a table
    const table = document.createElement('table');
    buttonContainer.appendChild(table);

    // Loop over each ticket and create a button for it
    for (let ticket of tickets) {
        // Create a row and a cell for each ticket
        const row = document.createElement('tr');
        const cell = document.createElement('td');

        // Create a button for each ticket
        const ticketButton = document.createElement('button');
        const ticketRef = firebase.firestore().collection('Borrow Tickets').doc(ticket);
        const ticketSnapshot = await ticketRef.get();

        if (ticketSnapshot.exists) {
            const ticketData = ticketSnapshot.data();
            ticketButton.textContent = `${ticketData.categorialNumber} - ${ticketData.product_name}`;
        } else {
            console.log('No data found for this ticket.');
            continue;
        }

        ticketButton.addEventListener('click', async () => {
            const itemDataRow = document.createElement('tr');
            const itemDataCell = document.createElement('td');

            const returnDetailsRow = document.createElement('tr');
            const returnDetailsCell = document.createElement('td');

            // Create a "Choose" button
            const chooseButton = document.createElement('button');
            chooseButton.textContent = "בחר";
            chooseButton.addEventListener('click', () => {
                returnDetails.style.display = 'block';
                ChosenTicket = ticket;
            });

            // Append the "Choose" button to the ticket data cell
            itemDataCell.appendChild(chooseButton);

            // Add the new cells to the rows
            itemDataRow.appendChild(itemDataCell);
            returnDetailsRow.appendChild(returnDetailsCell);

            // Add the new rows to the table
            table.appendChild(itemDataRow);
            table.appendChild(returnDetailsRow);

            await displayItemData(ticketSnapshot);
        });

        // Append the button to the cell and the cell to the row
        cell.appendChild(ticketButton);
        row.appendChild(cell);

        // Append the row to the table
        table.appendChild(row);
    }
}





async function searchItemByCategorialNumber(categorialNumber) {
  
    foundItemCategorialNumber = categorialNumber;

    // Search for the categorialNumber in the "Borrow Tickets" collection
    const borrowedTicketsRef = firebase.firestore().collection('Borrow Tickets');
    const querySnapshot = await borrowedTicketsRef.where('categorialNumber', '==', categorialNumber).get();
    if (querySnapshot.empty) {
        alert('המוצר אינו נמצא בכרטיסי המושאלים');
        return;
    }

    const buttonContainer = document.getElementById('buttonContainer');  // Replace 'buttonContainer' with the ID of your container

    // Loop over each document and create a button for it
    for (let doc of querySnapshot.docs) {
        const ticket = doc.id;
        const ticketButton = document.createElement('button');
        ticketButton.textContent = ticket; 

        ticketButton.addEventListener('click', async () => {
            const ticketSnapshot = await doc.ref.get();

            if (ticketSnapshot.exists) {
                // Check if the details are currently displayed
                if (itemData.style.display === 'block') {
                    // If they are, hide them
                    itemData.style.display = 'none';
                } else {
                    // If they're not, display the ticket data
                    await displayItemData(ticketSnapshot);

                    // Create a "Choose" button
                    const chooseButton = document.createElement('button');
                    chooseButton.textContent = "בחר";
                    chooseButton.addEventListener('click', () => {
                        returnDetails.style.display = 'block';
                        ChosenTicket = ticket;
                    });

                    // Append the "Choose" button to the ticket data
                    itemData.appendChild(chooseButton);
                    // Show the details
                    itemData.style.display = 'block';
                }
            } else {
                alert('No data found for this ticket.');
            }
        });

        // Append the button to the button container
        buttonContainer.appendChild(ticketButton);
    }
}


 async function displayItemData(itemSnapshot) {
        console.log()
        const borrowedItemsRef = firebase.firestore().collection('inventory').doc(itemSnapshot.data().categorialNumber);
        const borrowedItemSnapshot = await borrowedItemsRef.get();
        const item = borrowedItemSnapshot.data();
        BorrowItem=itemSnapshot.data();
    
    const detailsList = document.createElement('ul');

    const CatNumItem = document.createElement('li');
    CatNumItem.textContent = "מס סידורי: " + item.categorial_number;

    const ProductNameItem = document.createElement('li');
    ProductNameItem.textContent = "שם: " + item.product_name;

    const DescriptionItem = document.createElement('li');
    DescriptionItem.textContent = "תיאור: " + item.product_description;


    const RemarksItem = document.createElement('li');
    RemarksItem.textContent = "הערות: " + item.remarks;

    const AccessoriesItem = document.createElement('li');
    AccessoriesItem.textContent = "מוצרים נלווים: ";
    const accessories = item.companion_accessories;
    if (accessories) {
        accessories.forEach(keyword => {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = 'accessory-' + keyword.trim();
            checkbox.name = 'accessory';
            checkbox.value = keyword.trim();
            checkbox.checked = true;

            const label = document.createElement('label');
            label.htmlFor = 'accessory-' + keyword.trim();
            label.appendChild(document.createTextNode(keyword.trim()));

            AccessoriesItem.appendChild(checkbox);
            AccessoriesItem.appendChild(label);
        });
    }

    const ContactNameItem = document.createElement('li');
    ContactNameItem.textContent = "שם האיש קשר: " + BorrowItem.contactName;
    const ContactIDItem = document.createElement('li');
    ContactIDItem.textContent = "ת.ז האיש קשר: " + BorrowItem.contactId;
    const DateItem = document.createElement('li');
    DateItem.textContent = "תאריך השאלה: " + BorrowItem.borrowingFrom;
    const QuantityItem = document.createElement('li');
    QuantityItem.textContent = "כמות השאלה: " + BorrowItem.quantity;


    detailsList.appendChild(CatNumItem);
    detailsList.appendChild(ProductNameItem);
    detailsList.appendChild(DescriptionItem);
    detailsList.appendChild(ContactIDItem);
    detailsList.appendChild(QuantityItem);
    detailsList.appendChild(RemarksItem);
    detailsList.appendChild(DateItem);
    detailsList.appendChild(AccessoriesItem);
    detailsList.appendChild(ContactNameItem);
    detailsList.appendChild(AccessoriesItem);
    itemData.innerHTML = '';
    itemData.appendChild(detailsList);
    itemData.style.display = 'block';
}
   
searchByIdBtn.addEventListener('click', () => {
    // Clear the button container
    const buttonContainer = document.getElementById('buttonContainer');
    while (buttonContainer.firstChild) {
        buttonContainer.removeChild(buttonContainer.firstChild);
    }

    // Execute the search function
    searchItemById(searchInput.value);
});

searchByCatBtn.addEventListener('click', () => {
    // Clear the button container
    const buttonContainer = document.getElementById('buttonContainer');
    while (buttonContainer.firstChild) {
        buttonContainer.removeChild(buttonContainer.firstChild);
    }

    // Execute the search function
    searchItemByCategorialNumber(searchInput.value);
});
    returnBtn.addEventListener('click', async () => {
    try {
        console.log(ChosenTicket);
        const borrowedTicketsRef = firebase.firestore().collection('Borrow Tickets').doc(ChosenTicket);
        const borrowedTicketSnapshot = await borrowedTicketsRef.get();
        
        if (!borrowedTicketSnapshot.exists) {
            alert('No ticket found to return.');
            return;
        }

        const CatNum=borrowedTicketSnapshot.data().categorialNumber;
        const borrowedItemsRef = firebase.firestore().collection('Borrowed Items').doc(borrowedTicketSnapshot.data().contactId);
        const borrowedItemSnapshot = await borrowedItemsRef.get();
        borrowedItemData=borrowedItemSnapshot.data();
        // ... rest of your code

        // Update companion_accessories and quantity based on checkboxes and input
        const accessoryCheckboxes = document.getElementsByName('accessory');
        let updatedCompanionAccessories = [];
        for (let i = 0; i < accessoryCheckboxes.length; i++) {
            if (accessoryCheckboxes[i].checked) {
                updatedCompanionAccessories.push(accessoryCheckboxes[i].value);
            } else {
                updatedCompanionAccessories.push(accessoryCheckboxes[i].value + '-חסר');
            }
        }

        const returnQuantity = document.getElementById('return-quantity');
        let updatedQuantity = parseInt(returnQuantity.value);

        const borrowedArchiveData = {
            ...borrowedTicketSnapshot.data(),  // Copy the ticket data from 'Borrowed Tickets' collection
            returnedDate: new Date().toISOString().substring(0, 10),
            companion_accessories: updatedCompanionAccessories,  // Update the companion_accessories field
            quantity: updatedQuantity  // Update the quantity field
        };

        const borrowedArchiveRef = firebase.firestore().collection('Borrowed Archive').doc(ChosenTicket);
        const inventoryItemRef = firebase.firestore().collection('inventory').doc(CatNum);

        // Get the current quantity from the inventory first, and then add the returned quantity to it
        const inventoryItemSnapshot = await inventoryItemRef.get();
        const currentQuantity = inventoryItemSnapshot.data().product_quantity;
        updatedQuantity += currentQuantity;

        // Remove the ticket number from the 'borrowTickets' field array in the 'Borrowed Items' collection
        borrowedItemData.borrowTickets = borrowedItemData.borrowTickets.filter(ticket => ticket !== ChosenTicket);

        await borrowedArchiveRef.set(borrowedArchiveData);
        await borrowedTicketsRef.delete();  // Delete the ticket from 'Borrowed Tickets' collection

        await borrowedItemsRef.update({
        borrowTickets: firebase.firestore.FieldValue.arrayRemove(Number(ChosenTicket))
    });

    const updatedBorrowedItemSnapshot = await borrowedItemsRef.get();
    let updatedBorrowedItemData = updatedBorrowedItemSnapshot.data();

    // If the 'borrowTickets' array is empty, delete the document
    if (updatedBorrowedItemData.borrowTickets.length === 0) {
        await borrowedItemsRef.delete();
    }
        await inventoryItemRef.update({ status: 'free', location: returnLocation.value, companion_accessories: updatedCompanionAccessories, product_quantity: updatedQuantity });

        alert('Item has been successfully returned.');
        location.reload();
    } catch (error) {
        console.error('Error returning the borrowed item:', error);
        alert('Failed to return the borrowed item.');
    }
});

</script>
</body>
</html>