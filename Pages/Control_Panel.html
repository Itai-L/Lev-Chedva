<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../styles/Contol_Panel.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>כלי ניהול</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="../firebase.js"></script>
</head>
<body>
    <h1>כלי ניהול</h1>
    <button id="edit-locations">ערוך מחסנים</button>
    <button id="write-messages">כתוב הודעה</button>
    <button id="show-messages">צפה בהודעות</button>

    <div id="location-management" style="display:none;">
        <h2>ערוך מחסנים</h2>
        <select id="locations-dropdown"></select>
        <button id="edit-location">ערוך שם מחסן</button>
        <button id="delete-location">מחק מחסן</button>
        <button id="add-location">הוסף מחסן</button>
    </div>

    <div id="message-management" style="display:none;">
        <h2>כתוב הודעה</h2>
        <input type="text" id="header" placeholder="כותרת הודעה">
        <textarea id="message-text" rows="4" cols="50"></textarea>
        <button id="save-message">שמור</button>
    </div>

    <div id="message-list" style="display:none;">
        <h2>צפה בהודעות</h2>
        <div id="messages-container"></div>
    </div>
    <script>
const db = firebase.firestore();

const editLocationsBtn = document.getElementById('edit-locations');
const writeMessagesBtn = document.getElementById('write-messages');
const locationManagementDiv = document.getElementById('location-management');
const messageManagementDiv = document.getElementById('message-management');
const showMessagesBtn=document.getElementById('show-messages');

let isLocationManagementVisible = false;

editLocationsBtn.addEventListener('click', () => {
    isLocationManagementVisible = !isLocationManagementVisible;
    locationManagementDiv.style.display = isLocationManagementVisible ? 'block' : 'none';
    messageManagementDiv.style.display = 'none';
    messageListDiv.style.display = 'none';
    if (isLocationManagementVisible) {
        fetchLocations();
    }
});

let isMessageManagementVisible = false;

writeMessagesBtn.addEventListener('click', () => {
    isMessageManagementVisible = !isMessageManagementVisible;
    locationManagementDiv.style.display = 'none';
    messageManagementDiv.style.display = isMessageManagementVisible ? 'block' : 'none';
    messageListDiv.style.display = 'none';
});

let isMessageListVisible = false;

showMessagesBtn.addEventListener('click', () => {
    isMessageListVisible = !isMessageListVisible;
    locationManagementDiv.style.display = 'none';
    messageManagementDiv.style.display = 'none';
    messageListDiv.style.display = isMessageListVisible ?

    'block' : 'none';
if (isMessageListVisible) {
fetchMessages();
}
});

document.getElementById('add-location').addEventListener('click', async () => {
const newLocation = prompt('הכנס מחסן חדש');
if (newLocation) {
const toolsRef = db.collection('Tools').doc('Locations');
await toolsRef.update({
Location: firebase.firestore.FieldValue.arrayUnion(newLocation)
});
fetchLocations();
}
});

document.getElementById('edit-location').addEventListener('click', async () => {
const selectedLocation = document.getElementById('locations-dropdown').value;
const newLocationName = prompt('הכנס שם מחסן חדש', selectedLocation);
if (newLocationName && newLocationName !== selectedLocation) {
const toolsRef = db.collection('Tools').doc('Locations');
await toolsRef.update({
Location: firebase.firestore.FieldValue.arrayRemove(selectedLocation)
});
await toolsRef.update({
Location: firebase.firestore.FieldValue.arrayUnion(newLocationName)
});
fetchLocations();
}
});

document.getElementById('delete-location').addEventListener('click', async () => {
    const selectedLocation = document.getElementById('locations-dropdown').value;
    if (confirm(`האם אתה בטוח שאתה רוצה למחוק? ${selectedLocation}`)) {
        const toolsRef = db.collection('Tools').doc('Locations');
        await toolsRef.update({
            Location: firebase.firestore.FieldValue.arrayRemove(selectedLocation)
        });
        fetchLocations();
    }
});


document.getElementById('save-message').addEventListener('click', async () => {
const messageText = document.getElementById('message-text').value;
const header = document.getElementById('header').value;
if (messageText.trim() && header.trim()) {
const messageData = {
message: messageText.trim(),
timestamp: firebase.firestore.Timestamp.now()
};
await db.collection('messages').doc(header).set(messageData);
    alert('הודעה נשמרה בהצלחה');
    document.getElementById('message-text').value = '';
    document.getElementById('header').value = '';
} else {
    alert('הודעה לא תקנית');
}
});

const showMessageBtn = document.getElementById('show-messages');
const messageListDiv = document.getElementById('message-list');
const messagesContainer = document.getElementById('messages-container');

showMessageBtn.addEventListener('click', () => {
locationManagementDiv.style.display = 'none';
messageManagementDiv.style.display = 'none';
messageListDiv.style.display = 'block';
fetchMessages();
});

async function fetchMessages() {
messagesContainer.innerHTML = '';
const messagesRef = db.collection('messages');
const messagesSnapshot = await messagesRef.orderBy('timestamp', 'desc').get();
messagesSnapshot.forEach(messageDoc => {
    const messageData = messageDoc.data();
    const messageId = messageDoc.id;
    createMessageElement(messageId, messageData);
});
}
function createMessageElement(messageId, messageData) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    messageDiv.setAttribute('data-id', messageId);
    messageDiv.id = `message-${messageId}`;

    const headerDiv = document.createElement('div');
    headerDiv.classList.add('message-header');

    const headerText = document.createElement('h3');
    headerText.textContent = messageId;
    headerDiv.appendChild(headerText);

    const dateText = document.createElement('p');
    const date = messageData.timestamp.toDate();
    dateText.textContent = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
    headerDiv.appendChild(dateText);

    messageDiv.appendChild(headerDiv);

    const contentDiv = document.createElement('div');
    contentDiv.classList.add('message-content');
    contentDiv.style.display = 'none';

    const messageText = document.createElement('p');
    messageText.textContent = messageData.message;
    contentDiv.appendChild(messageText);

    const editHeaderBtn = document.createElement('button');
    editHeaderBtn.textContent = 'Edit Header';
    editHeaderBtn.addEventListener('click', () => editHeader(messageId));
    contentDiv.appendChild(editHeaderBtn);

    const editTextBtn = document.createElement('button');
    editTextBtn.textContent = 'Edit Text';
    editTextBtn.addEventListener('click', () => editMessage(messageId));
    contentDiv.appendChild(editTextBtn);

    messageDiv.appendChild(contentDiv);

    headerDiv.addEventListener('click', () => {
        if (contentDiv.style.display === 'none') {
            contentDiv.style.display = 'block';
        } else {
            contentDiv.style.display = 'none';
        }
    });

    messagesContainer.appendChild(messageDiv);
    const deleteBtn = document.createElement('button');
deleteBtn.textContent = 'Delete';
deleteBtn.addEventListener('click', () => deleteMessage(messageId));
contentDiv.appendChild(deleteBtn);
}


async function fetchLocations() {
    const locationsRef = db.collection('Tools').doc('Locations');
    const locationsSnapshot = await locationsRef.get();
    const locations = locationsSnapshot.data().Location;
    populateLocationsDropdown(locations);
}

function populateLocationsDropdown(locations) {
    const locationsDropdown = document.getElementById('locations-dropdown');
    locationsDropdown.innerHTML = '';
    locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location;
        option.textContent = location;
        locationsDropdown.appendChild(option);
    });
}


async function editHeader(messageId) {
    const messageDiv = document.getElementById(`message-${messageId}`);
    const header = messageDiv.querySelector('.message-header h3');
    const headerInput = document.createElement('input');
    headerInput.value = header.textContent;
    header.parentNode.replaceChild(headerInput, header);

    const saveButton = document.createElement('button');
    saveButton.textContent = 'Save';
    const cancelButton = document.createElement('button');
    cancelButton.textContent = 'Cancel';

    headerInput.parentNode.appendChild(saveButton);
    headerInput.parentNode.appendChild(cancelButton);

    saveButton.addEventListener('click', async () => {
        const newHeader = headerInput.value;
        const messageRef = db.collection('messages').doc(header.textContent);
        const messageData = (await messageRef.get()).data();

        await messageRef.delete();
        await db.collection('messages').doc(newHeader).set(messageData);

        header.textContent = newHeader;
        headerInput.parentNode.replaceChild(header, headerInput);
        saveButton.remove();
        cancelButton.remove();
    });

    cancelButton.addEventListener('click', () => {
        headerInput.parentNode.replaceChild(header, headerInput);
        saveButton.remove();
        cancelButton.remove();
    });
}


function editMessage(messageId) {
    const messageDiv = document.getElementById(`message-${messageId}`);
    const message = messageDiv.querySelector('.message-content p');
    const messageInput = document.createElement('textarea');
    messageInput.value = message.textContent;
    message.parentNode.replaceChild(messageInput, message);

    const saveButton = document.createElement('button');
    saveButton.textContent = 'Save';
    const cancelButton = document.createElement('button');
    cancelButton.textContent = 'Cancel';

    messageInput.parentNode.appendChild(saveButton);
    messageInput.parentNode.appendChild(cancelButton);

    saveButton.addEventListener('click', async () => {
        const newMessage = messageInput.value;
        const header = messageDiv.querySelector('.message-header h3');
        const messageRef = db.collection('messages').doc(header.textContent);
        await messageRef.update({ message: newMessage });
        message.textContent = newMessage;
        messageInput.parentNode.replaceChild(message, messageInput);
        saveButton.remove();
        cancelButton.remove();
    });

    cancelButton.addEventListener('click', () => {
        messageInput.parentNode.replaceChild(message, messageInput);
        saveButton.remove();
        cancelButton.remove();
    });
}

async function deleteMessage(messageId) {
    if (confirm('האם אתה בטוח שברצונך למחוק את ההודעה?')) {
        await db.collection('messages').doc(messageId).delete();
        const messageDiv = document.getElementById(`message-${messageId}`);
        messageDiv.remove();
    }
}


</script>

</body>
</html>