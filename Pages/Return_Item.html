<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles/Return_Item.css">
    <title>החזר מוצר</title>
</head>
<body>
    <input type="text" id="search-input" placeholder="Enter item ID or categorial number..." />
    <button id="search-by-id-btn">חפש לפי ת.ז</button>
    <button id="search-by-cat-btn">חפש לפי מק"ט</button>
    <div id="item-data" style="display: none;"></div>
    <div id="return-details" style="display: none;">
        <label>"שם המתנדב" <input type="text" id="return-name" /></label>
        <label>מיקום:
            <select id="return-location">
            </select>
        </label>
        <button id="return-btn">החזר</button>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="../firebase.js"></script>
    <script>
        const searchInput = document.getElementById('search-input');
        const searchByIdBtn = document.getElementById('search-by-id-btn');
        const searchByCatBtn = document.getElementById('search-by-cat-btn');
        const itemData = document.getElementById('item-data');
        const returnDetails = document.getElementById('return-details');
        const returnBtn = document.getElementById('return-btn');
        const returnName = document.getElementById('return-name');
        const returnLocation = document.getElementById('return-location');

        let foundItemId = null;
        let foundItemCategorialNumber = null;
    async function getLocations() {
            const locationsRef = firebase.firestore().collection('Tools').doc('Locations');
            const locationsSnapshot = await locationsRef.get();
            const locations = locationsSnapshot.data().Location;

            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.text = location;
                returnLocation.add(option);
            });
        }


        async function searchItemById(itemId) {
            const borrowedItemRef = firebase.firestore().collection('Borrowed Items').doc(itemId);
            const borrowedItemSnapshot = await borrowedItemRef.get();
            if (!borrowedItemSnapshot.exists) {
                alert('Item not found.');
                return;
            }

            foundItemId = itemId;
            foundItemCategorialNumber = borrowedItemSnapshot.data().categorialNumber;
            const inventoryItemRef = firebase.firestore().collection('inventory').doc(foundItemCategorialNumber);
            const inventoryItemSnapshot = await inventoryItemRef.get();

            if (!inventoryItemSnapshot.exists) {
                alert('Item not found in inventory.');
                return;
            }

            displayItemData(inventoryItemSnapshot);
        }

        async function searchItemByCategorialNumber(categorialNumber) {
    const inventoryItemRef = firebase.firestore().collection('inventory').doc(categorialNumber);
    const inventoryItemSnapshot = await inventoryItemRef.get();
    if (!inventoryItemSnapshot.exists || inventoryItemSnapshot.data().status !== 'borrowed') {
        alert('Item not found or not borrowed.');
        return;
    }
    foundItemCategorialNumber = categorialNumber;
    
    // Search for the number in the "Borrowed Items" collection
    const borrowedItemsRef = firebase.firestore().collection('Borrowed Items');
    const querySnapshot = await borrowedItemsRef.where('categorialNumber', '==', categorialNumber).get();
    if (querySnapshot.empty) {
        alert('Item not found in the "Borrowed Items" collection.');
        return;
    }
    
    // Get the first document (assuming there's only one document with this categorial number)
    const borrowedItemDoc = querySnapshot.docs[0];
    foundItemId = borrowedItemDoc.id;
    
    displayItemData(inventoryItemSnapshot);
}

function displayItemData(itemSnapshot) {
    getLocations();
    const item = itemSnapshot.data();

    const detailsList = document.createElement('ul');

    const CatNumItem = document.createElement('li');
    CatNumItem.textContent = "מס סידורי: " + item.categorial_number;

    const ProductNameItem = document.createElement('li');
    ProductNameItem.textContent = "שם: " + item.product_name;

    const DescriptionItem = document.createElement('li');
    DescriptionItem.textContent = "תיאור: " + item.product_description;

    const KeywordItem = document.createElement('li');
    KeywordItem.textContent = "מילות מפתח: " + item.keywords;

    const QuantityItem = document.createElement('li');
    QuantityItem.textContent = "כמות: " + item.product_quantity;

    const RemarksItem = document.createElement('li');
    RemarksItem.textContent = "הערות: " + item.remarks;

    const StatusItem = document.createElement('li');
    StatusItem.textContent = "סטאטוס: " + item.status; // Replace with your translation function if needed

    const AccessoriesItem = document.createElement('li');
    AccessoriesItem.textContent = "מוצרים נלווים: " + item.companion_accessories;

    const LocationItem = document.createElement('li');
    LocationItem.textContent = "מיקום: " + item.location;

    detailsList.appendChild(CatNumItem);
    detailsList.appendChild(ProductNameItem);
    detailsList.appendChild(DescriptionItem);
    detailsList.appendChild(KeywordItem);
    detailsList.appendChild(QuantityItem);
    detailsList.appendChild(RemarksItem);
    detailsList.appendChild(StatusItem);
    detailsList.appendChild(AccessoriesItem);
    detailsList.appendChild(LocationItem);

    itemData.innerHTML = '';
    itemData.appendChild(detailsList);

    itemData.style.display = 'block';
    returnDetails.style.display = 'block';
}
    searchByIdBtn.addEventListener('click', () => {
        searchItemById(searchInput.value);
    });

    searchByCatBtn.addEventListener('click', () => {
        searchItemByCategorialNumber(searchInput.value);
    });

    returnBtn.addEventListener('click', async () => {
    if (!foundItemId || !foundItemCategorialNumber) {
        alert('No item found to return.');
        return;
    }

    try {
        const borrowedItemsRef = firebase.firestore().collection('Borrowed Items').doc(foundItemId);
        const borrowedItemSnapshot = await borrowedItemsRef.get();
        const borrowedItemData = borrowedItemSnapshot.data();

        const borrowedArchiveData = {
            ...borrowedItemData,
            returnedDate: new Date().toISOString().substring(0, 10)
        };

        const borrowedArchiveRef = firebase.firestore().collection('Borrowed Archive').doc(foundItemCategorialNumber);
        const inventoryItemRef = firebase.firestore().collection('inventory').doc(foundItemCategorialNumber);

        await borrowedArchiveRef.set(borrowedArchiveData);
        await borrowedItemsRef.delete();
        await inventoryItemRef.update({ status: 'free', location: returnLocation.value });

        alert('Item has been successfully returned.');
        location.reload();
    } catch (error) {
        console.error('Error returning the borrowed item:', error);
        alert('Failed to return the borrowed item.');
    }
});

</script>
</body>
</html>